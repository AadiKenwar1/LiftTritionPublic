import { NavigationContainer } from "@react-navigation/native";
import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
import { createNativeStackNavigator } from "@react-navigation/native-stack";
import { Ionicons } from "@expo/vector-icons";
import { GestureHandlerRootView } from "react-native-gesture-handler";
import { WorkoutProvider } from "../context/WorkoutContextFunctions/WorkoutContext";
import TabBar from "../components/CustomHeader";
import { supabase } from "../lib/supabase"; // adjust path if needed
import { useState, useEffect } from "react";
import {
  useFonts,
  Inter_400Regular,
  Inter_700Bold,
} from "@expo-google-fonts/inter";
import { useWorkoutContext } from "../context/WorkoutContextFunctions/WorkoutContext";
import { SettingsProvider } from "../context/SettingsContext";
import { View, Text } from "react-native";
import { NutritionProvider } from "../context/NutritionContext/NutritionContext";

// Screens
import LogScreen from './Main/logScreen'
import WorkoutScreen from "./Main/WorkoutLogScreens/workoutsScreen";
import WorkoutDetails from "./Main/WorkoutLogScreens/exercisesScreen";
import LogDetails from "./Main/WorkoutLogScreens/logsScreen";
//import LoginScreen from "./Auth/LoginScreen";
//import SignupScreen from "./Auth/SignupScreen";
import SettingsScreen from "./Settings/Settings";
import ProgressScreen from './Main/progressScreen'

import ProfileScreen from "./Settings/SettingsOptions/Profile";
import TrainingFrequencyScreen from "./Settings/SettingsOptions/TrainingFrequency";
//import NotificationScreen from './Settings/Notifications'
import PrivacyScreen from "./Settings/SettingsOptions/Privacy";
//import AppearanceScreen from './Settings/Appearance'
import AboutScreen from "./Settings/SettingsOptions/About";
import SupportScreen from "./Settings/SettingsOptions/Support";
import UserExercisesScreen from "./Settings/SettingsOptions/UserExercises";
import AdjustMacrosScreen from "./Settings/SettingsOptions/AdjustMacros";

import ChangePasswordScreen from "./Settings/SettingsOptions/AccountSettings/ChangePassword";
import DeleteAccountScreen from "./Settings/SettingsOptions/AccountSettings/DeleteAccount";

import CameraScreen from './Camera'

const Tab = createBottomTabNavigator();
const Stack = createNativeStackNavigator();

function TabNavigator() {
  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ color, size, focused }) => {
          let iconName;
          let iconSize = focused ? 28 : 24;

          if (route.name === "Log") iconName = "clipboard-outline";
          else if (route.name === "Progress") iconName = "analytics-outline";
          else if (route.name === "Account") iconName = "person";

          return (
            <View
              style={{
                alignItems: "center",
                justifyContent: "center",
                shadowColor: focused ? "#00BFFF" : "transparent",
                shadowOpacity: focused ? 0.4 : 0,
                shadowRadius: focused ? 8 : 0,
                elevation: focused ? 8 : 0,
              }}
            >
              <Ionicons name={iconName} size={iconSize} color={color} />
            </View>
          );
        },

        tabBarActiveTintColor: "white",
        tabBarInactiveTintColor: "gray",
        tabBarLabelStyle: {
          fontSize: 12,
          fontWeight: "600",
          paddingBottom: 4,
        },
        tabBarStyle: {
          position: "absolute",
          left: 20,
          right: 20,
          backgroundColor: "#121212",
          height: 100,
          paddingTop:10,
          shadowColor: "#000",
          shadowOpacity: 0.15,
          shadowRadius: 8,
          borderTopWidth: 0,
        },
        headerShown: false,
      })}
    >
      <Tab.Screen name="Log" component={LogScreen} />
      <Tab.Screen name="Progress" component={ProgressScreen} />
      <Tab.Screen name="Account" component={SettingsScreen} />
    </Tab.Navigator>
  );
}

export default function App() {

  const [fontsLoaded] = useFonts({
    Inter_400Regular,
    Inter_700Bold,
  });
  
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setLoading(false);
    });

    const { data: listener } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session);
      },
    );

    return () => listener.subscription.unsubscribe();
  }, []);

  if (loading || !fontsLoaded) {
    return (
      <View
        style={{
          flex: 1,
          justifyContent: "center",
          alignItems: "center",
          backgroundColor: "black",
        }}
      >
        <Text style={{ color: "black" }}>Loading...</Text>
      </View>
    );
  }

  return (
    <SettingsProvider>
      <WorkoutProvider>
        <NutritionProvider>
          <GestureHandlerRootView style={{ flex: 1 }}>
            <NavigationContainer>
              <Stack.Navigator screenOptions={{ headerShown: false }}>
                {session ? (
                  <>
                    <Stack.Screen name="Tabs" component={TabNavigator} />
                    <Stack.Screen
                      name="WorkoutDetails"
                      component={WorkoutDetails}
                      options={{ title: "Exercises", ...styles, animation: 'slide_from_bottom', animationDuration: 350,}}
                    />
                    <Stack.Screen
                      name="LogDetails"
                      component={LogDetails}
                      options={{ title: "Logs", ...styles }}
                    />
                    <Stack.Screen
                      name="Profile"
                      component={ProfileScreen}
                      options={{ title: "Profile", ...styles }}
                    />
                    <Stack.Screen
                      name="TrainingFrequency"
                      component={TrainingFrequencyScreen}
                      options={{ title: "Training Frequency", ...styles }}
                    />
                    <Stack.Screen
                      name="Privacy"
                      component={PrivacyScreen}
                      options={{ title: "Privacy", ...styles }}
                    />
                    <Stack.Screen
                      name="About"
                      component={AboutScreen}
                      options={{ title: "About", ...styles }}
                    />
                    <Stack.Screen
                      name="Support"
                      component={SupportScreen}
                      options={{ title: "Support", ...styles }}
                    />
                    <Stack.Screen
                      name="ChangePassword"
                      component={ChangePasswordScreen}
                      options={{ title: "ChangePassword", ...styles }}
                    />
                    <Stack.Screen
                      name="UserExercisesScreen"
                      component={UserExercisesScreen}
                      options={{ title: "UserExercisesScreen", ...styles }}
                    />
                    <Stack.Screen
                      name="DeleteAccount"
                      component={DeleteAccountScreen}
                      options={{ title: "DeleteAccount", ...styles }}
                    />
                    <Stack.Screen
                      name="CameraScreen"
                      component={CameraScreen}
                      options={{ title: "CameraScreen", ...styles }}
                    />
                    <Stack.Screen
                      name="AdjustMacros"
                      component={AdjustMacrosScreen}
                      options={{ title: "AdjustMacrosScreen", ...styles }}
                    />


                  </>
                ) : (
                  <>
                    <Stack.Screen name="Login" component={LoginScreen} />
                    <Stack.Screen name="Signup" component={SignupScreen} />
                  </>
                )}
              </Stack.Navigator>
            </NavigationContainer>
          </GestureHandlerRootView>
        </NutritionProvider>
      </WorkoutProvider>
    </SettingsProvider>
  );
}

const styles = {
  headerShown: false,
  headerStyle: { backgroundColor: "black" },
  headerTintColor: "#fff",
  headerTitleStyle: { fontWeight: "bold" },
  headerTitleStyle: "white",
};
